@startuml

/'
  Legend
  - <<module>>: Python module
  - <<Flask app>>: Flask application module exposing routes
  - <<JavaScript>>: JavaScript in gui/index.html
  - <<script>>: Standalone script (no functions)
'/

skinparam classAttributeIconSize 0

package "gui" {
  class IndexHTML <<JavaScript>> {
    +doAjax(url, method, responseHandler, data)
    +getHttpRequestObject()
    +selectLogs()
    +selectLogsHandler()
    +resourceFiltering(key)
    +selectFilterHandler()
    +caseFiltering(key)
    +selectCaseHandler()
    +discoverActivityTree(key)
    +discoverPerformanceTree(key)
    +discoverResourceTree(key)
    +discoverLocationsTree(key)  ' calls /discover/locations (not implemented server-side)
    +discoverAll()
    +discoverAllPerformance()
    +scatterAll()
    +showScatter3DAll()
    +view_plot(key)
    +updateTree()
    +updateArea()
    +showScatterHandler()
    +showHeatmapHandler()
    +showAreaHandler()
    +show3DScatter()
    +csvParser()
    +printResponse()
    +openLink(e)
    +showHide(div)
    +getMethods(obj)
  }

  note right of IndexHTML
    Calls server endpoints via AJAX:
    - /init
    - /select/logs
    - /filter
    - /filter/resource
    - /filter/case
    - /discover/resource
    - /discover/activity
    - /discover/performance
    - /discover/all
    - /discover/all/performance
    - /view/3Dscatter
    - /view/3Dscatter/all
    - /show/area
    - /show/scatter2D
    - /show/heatmap
    - /case_filtering
    - /open-url
    - /csv/parse
    WARNING: calls /discover/locations (not implemented)
  end note
}

package "src/backend" {
  class app <<module>> {
    +initialize() : bool
    +do_stuff() : str
  }

  class main <<module>> {
    ..entry point..
    ' __main__: creates PyWebview window with Flask server, starts webview
  }

  class server <<Flask app>> {
    ..module globals..
    -gui_dir : str
    -server : Flask
    -files_dict : dict
    -heatmap_data : dict
    -resource : str
    -case_select : str
    -case_check : bool

    ..decorators & hooks..
    +verify_token(function)
    +add_header(response)

    ..routes..
    +landing()
    +csv_processing()
    +initialize()
    +choose_path()
    +get_resources()               ' route: /filter (returns resources list)
    +parse_csv()
    +discover_all()
    +discover_all_p()
    +create_scatter3D()
    +create_scatter3D_all()
    +create_plot_area()
    +create_2dscatter()
    +create_heatmap()
    +discover_dfg()
    +discover_performance()
    +filter_resource()
    +filter_cases()
    +case_filtering()
    +discover_resource()
    +open_url()

    ..helpers..
    +log_to_dataframe(log_path) : pandas.DataFrame
    +generate_heatmap_data(log_path)
    +test(activities_count) : dict
    +create_dfg(file_path, location_graph=false, resource='')
    +create_dist_dfg(file_path, location_graph=false)
    +get_resources(file_path) : dict    ' helper: attribute values
    +create_performance(file_path, location_graph=false)
  }

  class xes_handler <<module>> {
    +csv_to_xes(path) : str
    +merge_xes(paths: dict) : str
  }

  class process_inprogress <<module>> {
    ..constants..
    -out_file : str = "temp_all.csv"
    -maxy : float = 9.5

    ..functions..
    +assign_progressive_state(path)
    +csv_to_xes(path) : str
    +renaming(column: str) : str
    +apply_odom(path)
  }
}

package "src/utilities" {
  class generator <<module>> {
    ..module globals..
    -file : str
    -events : list
    -out_list : list
    -tractors : dict
    -start : str
    -complete : str
    -caseid : int
    -obj : dict

    ..functions..
    +out_append(time, act, lifecycle, payload, x, y, z, case)
    +add_to(time, case) : (end_time, x, y, z)
    +add_explore(x_start, y_start, z_start, time, case, init, counter)
    +add_weedhandler(x_stop, y_stop, z_out, weedf_time, case, init) : datetime
    +add_end(x, y, z, time, case)
  }

  class generator_tractor <<module>> {
    ..module globals..
    -file : io.TextIOBase
    -events : list
    -out_list : list
    -tractors : dict
    -start : str
    -complete : str
    -caseid : int
    -obj : dict

    ..functions..
    +do(tractor_name)
    +out_append(time, act, lifecycle, payload, x, y, z, case)
    +append_movements(time, case, xsta, ysta, xsto, ysto)
    +add_end(x, y, z, time, case)
  }

  class handle <<script>> {
    ..top-level script to normalize CSV lifecycle and coordinates..
  }

  class odom <<script>> {
    ..top-level script to align odometry with activity intervals..
  }

  class piton <<script>> {
    ..top-level script to flatten logs into spaghetti CSVs..
  }

  class plot <<script>> {
    ..top-level script to visualize CSV in 3D via Plotly..
  }

  class "script copy" as script_copy <<script>> {
    ..top-level script to adjust z for WEED_POSITION..
  }

  class script <<script>> {
    ..top-level script to normalize lifecycle and coordinates..
  }

  class "sort copy" as sort_copy <<script>> {
    ..top-level script to concatenate and sort CSVs by time..
  }

  class sort <<script>> {
    ..top-level script to add resource column and merge/sort CSVs..
  }
}

'-----------------------------
' Dependencies and interactions
'-----------------------------

main ..> server : imports Flask app "server"
server ..> app : calls initialize()
server ..> xes_handler : uses csv_to_xes(), merge_xes()
server ..> "Flask" : framework usage <<external>>
server ..> "webview" : token, dialogs <<external>>
server ..> "pm4py" : mining/log APIs <<external>>
server ..> "plotly.express" : 3D scatter <<external>>
server ..> "pandas" : DataFrame handling <<external>>
server ..> "xml.etree.ElementTree" : XES parse <<external>>

IndexHTML ..> server : HTTP endpoints (see note)

process_inprogress ..> "pandas" <<external>>
process_inprogress ..> "xml.etree.ElementTree" <<external>>
process_inprogress ..> "pm4py" <<external>>

generator ..> "random" <<external>>
generator ..> "datetime" <<external>>
generator_tractor ..> "json" <<external>>

xes_handler ..> "pandas" <<external>>
xes_handler ..> "pm4py" <<external>>
xes_handler ..> "xml.etree.ElementTree" <<external>>

@enduml