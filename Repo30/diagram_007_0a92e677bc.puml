@startuml

skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam wrapWidth 220
skinparam maxMessageSize 200

node "Training Host" as host {
  node "CPU (fallback when no CUDA)" as cpu

  node "GPU0 (cuda:0)" as gpu0
  node "GPU1 (cuda:1)" as gpu1

  folder "Local FS (basePath)" as fs {
    artifact "FoldForCV.xlsx" as xl

    folder "ONLY_MRI_final/<class>/*.mat" as mri_data
    folder "ONLY_PET_final/<class>/*.mat" as pet_data
    folder "PAIRED_final/<class>/*.mat" as paired_data

    folder "MedicalNet_pytorch_files2/pretrain" as mednet {
      artifact "resnet_34_23dataset.pth" as r34
      artifact "resnet_18_...pth/resnet_50_...pth (if used)" as rXX
    }

    folder "Unimodal weights" as uni {
      artifact "MRI_RESULTS/FoldX/best_model_weights.pth" as umi
      artifact "PET_RESULTS/FoldX/best_model_weights.pth" as upet
      note right
        Only used by IF_BasicNet and IF_ResNet variants.
        Paths are provided in MAIN_TRAIN.py.
      end note
    }

    package "Run outputs (outputPath)" as out {
      artifact "train_weights.pth / best_model_weights.pth" as pth_std
      artifact "best_*_weights.pth (per-part for IF_ResNet)" as pth_parts
      artifact "check_point.mat" as chk
      artifact "Max_min_MRI.mat / Max_min_PET.mat" as minmax
      artifact "Mean_std_*.mat (if z-score enabled)" as meanstd
      artifact "lossTrain.txt / lossVal.txt / Acc*.txt" as logs
      artifact "LossTrainVal.png / AccTrainVal.png / AccVal.png" as plots
      artifact "TabellaBestModel*.csv" as csv
    }
  }

  component "EF_BasicNet Training\n(Multimodal_EF_BasicNet/MAIN_TRAIN.py)\nModel: MyNet_Simple(2,ch,num_classes)" as ef_basic
  component "EF_ResNet Training\n(Multimodal_EF_ResNet/MAIN_TRAIN.py)\nModel: MyMedicalResNet(typeResNet, pretrain, inputChannel=2)" as ef_res
  component "IF_BasicNet Training\n(Multimodal_IF_BasicNet/MAIN_TRAIN.py)\nModel: MyNet_Multimodal(BasicNet MRI/PET parts + heads)" as if_basic
  component "IF_ResNet Training\n(Multimodal_IF_ResNet/MAIN_TRAIN.py)\nModel: MyNet_MultimodalMedicalNet(ResNet MRI/PET parts + heads)" as if_res

  ' Device bindings from code
  ef_basic ..> gpu1 : device = cuda:1 (or CPU)
  ef_basic ..> cpu : fallback if no CUDA

  ef_res ..> gpu0 : device = cuda:0 (or CPU)
  ef_res ..> cpu : fallback if no CUDA

  if_basic ..> gpu1 : model.to(device), device = cuda:1 (or CPU)
  if_basic ..> cpu : fallback if no CUDA
  note right of if_basic
    Loads unimodal parts from:
    - MRI: MRI_RESULTS/FoldX/best_model_weights.pth
    - PET: PET_RESULTS/FoldX/best_model_weights.pth
    Weight load map_location may reference cuda:0; the
    assembled model is then moved to 'device'.
  end note

  if_res ..> gpu0 : PET path + FC heads on cuda:0
  if_res ..> gpu1 : MRI path on cuda:1
  note right of if_res
    Split placement (from code):
    - mri_part on cuda:1
    - pet_part on cuda:0
    - fc_mri, fc_pet, fc_both on cuda:0
    Tensors are moved across devices as needed.
  end note

  ' Data and artifact flows (all variants read Excel and data; write outputs)
  ef_basic --> xl : read CV folds
  ef_res   --> xl : read CV folds
  if_basic --> xl : read CV folds
  if_res   --> xl : read CV folds

  ef_basic --> mri_data : read for normalization (range/zscore)
  ef_basic --> pet_data : read for normalization (range/zscore)
  ef_basic --> paired_data : training/val/test samples
  ef_basic --> out : write pth_std, chk, minmax, logs, plots, csv

  ef_res   --> mri_data
  ef_res   --> pet_data
  ef_res   --> paired_data
  ef_res   --> r34 : load MedicalNet pretrain
  ef_res   --> rXX : optionally other ResNet variants
  ef_res   --> out : write pth_std, chk, minmax, logs, plots, csv

  if_basic --> mri_data
  if_basic --> pet_data
  if_basic --> paired_data
  if_basic --> umi : load unimodal MRI weights
  if_basic --> upet : load unimodal PET weights
  if_basic --> out : write pth_std, chk, minmax, logs, plots, csv

  if_res   --> mri_data
  if_res   --> pet_data
  if_res   --> paired_data
  if_res   --> r34 : load MedicalNet pretrain
  if_res   --> rXX : optionally other ResNet variants
  if_res   --> umi : load unimodal MRI weights
  if_res   --> upet : load unimodal PET weights
  if_res   --> out : write pth_parts, chk, minmax, logs, plots, csv

  note right of ef_basic
    In some scripts:
    - CUDA_DEVICE_ORDER = PCI_BUS_ID
    - CUDA_VISIBLE_DEVICES = '1'
    Explicitly pins to GPU index 1.
  end note

  note right of mri_data
    Class subfolders: CN, MILD, SEVERE
    Files: MATLAB .mat volumes with MRI or PET and crop coords
    Datasets accessed via custom torch.utils.data Datasets.
    Applies to MRI, PET and paired folders.
  end note
}

@enduml