@startuml

/'
  Legend:
  - Each component corresponds to a concrete source file in the repository.
  - Packages group related components (subsystems).
  - Dependencies are shown among packages (key flows).
'/


package "Compiler" as CompilerPkg {
  [treeco.compiler]
  [treeco.__main__]
}

package "Frontend" as FrontendPkg {
  [treeco.frontend.__init__]
  [treeco.frontend.parser]
  [treeco.frontend.ir_gen]
}

package "Dialects" as DialectsPkg {
  package "treeco.dialects" {
    [treeco.dialects.__init__]
    [treeco.dialects.treeco]
    [treeco.dialects.crown]
    [treeco.dialects.trunk]
    [treeco.dialects.onnxml]
    [treeco.dialects.emitc]
  }
  package "treeco.dialects.extended" {
    [treeco.dialects.extended.__init__]
    [treeco.dialects.extended.tensor]
    [treeco.dialects.extended.ml_program]
    [treeco.dialects.extended.bufferization]
  }
}

package "Lowering" as LoweringPkg {
  [treeco.lowering.__init__]
  [treeco.lowering.convert_onnxml_to_crown]
  [treeco.lowering.convert_crown_to_trunk]
  [treeco.lowering.lower_trunk]
  [treeco.lowering.lower_treeco]
  [treeco.lowering.convert_ml_program_to_memref]
  [treeco.lowering.bufferize]
  [treeco.lowering.convert_scf_to_cf]
  [treeco.lowering._utils_trunk_leaf_aggregate]
  [treeco.lowering.mlir_opt]

  package "EmitC Lowering" {
    [treeco.lowering.emitc.convert_arith_to_emitc]
    [treeco.lowering.emitc.convert_memref_to_emitc]
    [treeco.lowering.emitc.convert_printf_to_emitc]
    [treeco.lowering.emitc.convert_scf_to_emitc]
  }
}

package "Transforms" as TransformsPkg {
  [treeco.transforms.__init__]
  [treeco.transforms.crown_pad_to_perfect]
  [treeco.transforms.crown_prune]
  [treeco.transforms.crown_quantize]
  [treeco.transforms.crown_voting]
  [treeco.transforms.func_legalize]
  [treeco.transforms.memref_merge_subview]
  [treeco.transforms.memref_quantize_global_index]
  [treeco.transforms.ml_global_quantize_index]
  [treeco.transforms.prepare_llvm_lowering]
  [treeco.transforms.trunk_pad_to_min_depth]
}

package "Targets" as TargetsPkg {
  [treeco.targets.__init__]
  [treeco.targets.codegen_main]

  package "LLVM" as TargetsLLVMPkg {
    [treeco.targets.llvm.__init__]
    [treeco.targets.llvm.transforms]
    [treeco.targets.llvm.standalone]
    [treeco.targets.llvm.library]
  }

  package "C++/EmitC" as TargetsCPPPkg {
    [treeco.targets.cpp.__init__]
    [treeco.targets.cpp.transforms]
    [treeco.targets.cpp.standalone]
  }
}

package "Model" as ModelPkg {
  [treeco.model.__init__]
  [treeco.model.ensemble]
  [treeco.model.node]
}

package "Utils" as UtilsPkg {
  [treeco.utils.__init__]
  [treeco.utils.utils]
  [treeco.utils.numpy_to_xdsl]
  [treeco.utils.xdsl_to_numpy]
  [treeco.utils.xdsl_utils]
}

package "External" as ExternalPkg {
  [xdsl (framework)]
  [onnx]
  [numpy]
  [bigtree]
  [mlir-opt]
  [mlir-translate]
  [clang]
  [ctypes]
}

/'
  Key inter-package dependencies (derived from imports and usage):
'/


' Entry and orchestration
[treeco.__main__] --> [treeco.compiler]
CompilerPkg --> FrontendPkg
CompilerPkg --> DialectsPkg
CompilerPkg --> LoweringPkg
CompilerPkg --> TransformsPkg
CompilerPkg --> TargetsPkg
CompilerPkg --> UtilsPkg
CompilerPkg --> ModelPkg
CompilerPkg --> ExternalPkg

' Frontend dependencies
[treeco.frontend.parser] --> [onnx]
[treeco.frontend.parser] --> [numpy]
[treeco.frontend.ir_gen] --> [xdsl (framework)]
[treeco.frontend.ir_gen] --> [treeco.dialects.onnxml]
[treeco.frontend.ir_gen] --> [treeco.dialects.extended.ml_program]
[treeco.frontend.ir_gen] --> [treeco.dialects.extended.tensor]
[treeco.frontend.ir_gen] --> [treeco.dialects.crown] ' via conversion path downstream

' Dialects depend on xdsl primitives
DialectsPkg --> [xdsl (framework)]

' Lowering dependencies
[treeco.lowering.convert_onnxml_to_crown] --> [treeco.dialects.onnxml]
[treeco.lowering.convert_onnxml_to_crown] --> [treeco.dialects.crown]
[treeco.lowering.convert_onnxml_to_crown] --> [treeco.dialects.treeco]
[treeco.lowering.convert_crown_to_trunk] --> [treeco.dialects.crown]
[treeco.lowering.convert_crown_to_trunk] --> [treeco.dialects.trunk]
[treeco.lowering.convert_crown_to_trunk] --> [treeco.dialects.extended.tensor]
[treeco.lowering.convert_crown_to_trunk] --> [treeco.dialects.extended.bufferization]
[treeco.lowering.convert_crown_to_trunk] --> [ModelPkg]
[treeco.lowering.lower_trunk] --> [treeco.dialects.trunk]
[treeco.lowering.lower_trunk] --> [treeco.dialects.extended.ml_program]
[treeco.lowering.lower_trunk] --> [treeco.dialects.extended.tensor]
[treeco.lowering.lower_trunk] --> [treeco.dialects.treeco]
[treeco.lowering.lower_trunk] --> [ModelPkg]
[treeco.lowering.lower_treeco] --> [treeco.dialects.treeco]
[treeco.lowering.convert_ml_program_to_memref] --> [treeco.dialects.extended.ml_program]
[treeco.lowering.convert_ml_program_to_memref] --> [xdsl (framework)]
[treeco.lowering.bufferize] --> [mlir-opt]
[treeco.lowering.convert_scf_to_cf] --> [mlir-opt]
[treeco.lowering.mlir_opt] --> [mlir-opt]

' EmitC lowering depends on EmitC dialect and xdsl IR
[treeco.lowering.emitc.convert_arith_to_emitc] --> [treeco.dialects.emitc]
[treeco.lowering.emitc.convert_memref_to_emitc] --> [treeco.dialects.emitc]
[treeco.lowering.emitc.convert_printf_to_emitc] --> [treeco.dialects.emitc]
[treeco.lowering.emitc.convert_scf_to_emitc] --> [treeco.dialects.emitc]
[treeco.lowering.emitc.convert_*] --> [xdsl (framework)]

' Transforms dependencies
TransformsPkg --> [treeco.dialects.crown]
TransformsPkg --> [treeco.dialects.treeco]
TransformsPkg --> [treeco.dialects.trunk]
TransformsPkg --> [UtilsPkg]
TransformsPkg --> [ModelPkg]
TransformsPkg --> [xdsl (framework)]

' Targets: LLVM
[treeco.targets.llvm.transforms] --> [UtilsPkg]
[treeco.targets.llvm.transforms] --> [mlir-opt]
[treeco.targets.llvm.standalone] --> [xdsl (framework)]
[treeco.targets.llvm.standalone] --> [numpy]
[treeco.targets.llvm.library] --> [mlir-translate]
[treeco.targets.llvm.library] --> [clang]
[treeco.targets.llvm.library] --> [ctypes]
[treeco.targets.llvm.library] --> [numpy]

' Targets: C++/EmitC
[treeco.targets.cpp.transforms] --> [treeco.dialects.emitc]
[treeco.targets.cpp.transforms] --> [mlir-opt]
[treeco.targets.cpp.standalone] --> [treeco.dialects.emitc]
[treeco.targets.cpp.standalone] --> [xdsl (framework)]
[treeco.targets.codegen_main] --> [UtilsPkg]
[treeco.targets.codegen_main] --> [xdsl (framework)]
[treeco.targets.codegen_main] --> [numpy]

' Model uses numpy and bigtree
ModelPkg --> [numpy]
ModelPkg --> [bigtree]

' Utils use xdsl and numpy, and invoke mlir-opt
UtilsPkg --> [xdsl (framework)]
UtilsPkg --> [numpy]
[treeco.utils.__init__] --> [mlir-opt]

@enduml