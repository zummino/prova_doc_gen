@startuml

skinparam componentStyle rectangle
skinparam defaultTextAlignment center

' ========== General-PLC ==========
package "General-PLC (central orchestrator)" {
  component "modbus_server.py\nTCP 502" as GPLC_S
  component "main.py\norchestration logic" as GPLC_M
  note bottom of GPLC_M
    - Reads local coils via 127.0.0.1:502
    - Writes setpoints to remote PLCs
    - Reads back statuses from remote PLCs
    - Persists summary to status.txt
  end note
  GPLC_M -down-> GPLC_S : Local Modbus TCP\n127.0.0.1:502
}

' ========== S-PLC ==========
package "S-PLC @ 10.0.1.45" {
  component "modbus_server.py\nTCP 502" as SPLC_S
  component "main.py" as SPLC_M
  SPLC_M -down-> SPLC_S : Local Modbus TCP\n127.0.0.1:502
}

' S-IEDs
package "S-IED1 @ 10.0.1.34" {
  component "modbus_server.py\nTCP 502" as SIED1_S
  component "main.py\nlocal read/write coils 0/1" as SIED1_M
  SIED1_M -down-> SIED1_S : Local Modbus TCP\n127.0.0.1:502
}
package "S-IED2 @ 10.0.1.35" {
  component "modbus_server.py\nTCP 502" as SIED2_S
  component "main.py" as SIED2_M
  SIED2_M -down-> SIED2_S : Local Modbus TCP\n127.0.0.1:502
}
package "S-IED3 @ 10.0.1.36" {
  component "modbus_server.py\nTCP 502" as SIED3_S
  component "main.py" as SIED3_M
  SIED3_M -down-> SIED3_S : Local Modbus TCP\n127.0.0.1:502
}
package "S-IED4 @ 10.0.1.37" {
  component "modbus_server.py\nTCP 502" as SIED4_S
  component "main.py" as SIED4_M
  SIED4_M -down-> SIED4_S : Local Modbus TCP\n127.0.0.1:502
}

' ========== T-PLC ==========
package "T-PLC @ 10.0.1.61" {
  component "modbus_server.py\nTCP 502" as TPLC_S
  component "main.py" as TPLC_M
  TPLC_M -down-> TPLC_S : Local Modbus TCP\n127.0.0.1:502
}

' T-IEDs
package "T-IED1 @ 10.0.1.50" {
  component "modbus_server.py\nTCP 502" as TIED1_S
  component "main.py" as TIED1_M
  TIED1_M -down-> TIED1_S : Local Modbus TCP\n127.0.0.1:502
}
package "T-IED2 @ 10.0.1.51" {
  component "modbus_server.py\nTCP 502" as TIED2_S
  component "main.py" as TIED2_M
  TIED2_M -down-> TIED2_S : Local Modbus TCP\n127.0.0.1:502
}
package "T-IED3 @ 10.0.1.52" {
  component "modbus_server.py\nTCP 502" as TIED3_S
  component "main.py" as TIED3_M
  TIED3_M -down-> TIED3_S : Local Modbus TCP\n127.0.0.1:502
}

' ========== M-PLC ==========
package "M-PLC @ 10.0.0.192" {
  component "modbus_server.py\nTCP 502" as MPLC_S
  component "main.py" as MPLC_M
  MPLC_M -down-> MPLC_S : Local Modbus TCP\n127.0.0.1:502
}

' M-IEDs
package "M-IED1 @ 10.0.0.21" {
  component "modbus_server.py\nTCP 502" as MIED1_S
  component "main.py" as MIED1_M
  MIED1_M -down-> MIED1_S : Local Modbus TCP\n127.0.0.1:502
}
package "M-IED2 @ 10.0.0.22" {
  component "modbus_server.py\nTCP 502" as MIED2_S
  component "main.py" as MIED2_M
  MIED2_M -down-> MIED2_S : Local Modbus TCP\n127.0.0.1:502
}

' ========== G-PLC ==========
package "G-PLC @ 10.0.1.93" {
  component "modbus_server.py\nTCP 502" as GPLX_S
  component "main.py" as GPLX_M
  GPLX_M -down-> GPLX_S : Local Modbus TCP\n127.0.0.1:502
}

' G-IED
package "G-IED1 @ 10.0.1.82" {
  component "modbus_server.py\nTCP 502" as GIED1_S
  component "main.py" as GIED1_M
  GIED1_M -down-> GIED1_S : Local Modbus TCP\n127.0.0.1:502
}

' ===== Runtime Modbus TCP interactions (remote) =====
' General-PLC <-> all PLCs
GPLC_M -right-> SPLC_S : Modbus TCP 502\nwrite coils [0..3]\nread coils [8,16,24]
GPLC_M -right-> TPLC_S : Modbus TCP 502\nwrite coils [0..2]\nread coils [8,16]
GPLC_M -down-> MPLC_S : Modbus TCP 502\nwrite coils [0..1]\nread coils [8]
GPLC_M -down-> GPLX_S : Modbus TCP 502\nwrite coil [0]\nread coils [8]

' Each PLC <-> its IEDs
SPLC_M -right-> SIED1_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 8
SPLC_M -right-> SIED2_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 16
SPLC_M -right-> SIED3_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 24
SPLC_M -right-> SIED4_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 32

TPLC_M -right-> TIED1_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 8
TPLC_M -right-> TIED2_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 16
TPLC_M -right-> TIED3_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 24

MPLC_M -down-> MIED1_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 8
MPLC_M -down-> MIED2_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 16

GPLX_M -right-> GIED1_S : Modbus TCP 502\nwrite coil 0\nread coil 1->local 8

' ====== On-path manipulation nodes (optional, separate hosts) ======
package "AttackerNode (NetfilterQueue)" {
  component "coilModification.py" as AN_C
  component "coilModificationStealth.py" as AN_CS
  note bottom of AN_C
    Hooks iptables NFQUEUE 1 on OUTPUT/FORWARD.
    Targets ModbusPDU05WriteSingleCoilRequest
    if IP src=10.0.1.66 and dst=10.0.0.192.
    Forces outputValue=0 for outputAddr==0.
  end note
  note bottom of AN_CS
    In addition, for responses from 10.0.0.192,
    rewrites ModbusPDU01ReadCoilsResponse.coilStatus.
  end note
}

package "AttackerNode-ARP (NetfilterQueue)" {
  component "coilModification.py" as AARP_C
  component "coilModificationStealth.py" as AARP_CS
  note bottom of AARP_C
    Hooks iptables NFQUEUE 1 on OUTPUT/FORWARD.
    Targets M-PLC(10.0.0.192) -> M-IED1(10.0.0.21):
    ModbusPDU05WriteSingleCoilRequest.outputValue := 0xff00.
  end note
  note bottom of AARP_CS
    Additionally for 10.0.0.21 -> 10.0.0.192 responses:
    rewrites ModbusPDU01ReadCoilsResponse.coilStatus := 0.
  end note
}

' Depict interception relationships (logical, on-path)
AN_C .. MPLC_S : Intercepts traffic\ninvolving 10.0.0.192
AN_CS .. MPLC_S : Intercepts responses\nfrom 10.0.0.192
AARP_C .. MPLC_M : Intercepts 10.0.0.192 -> 10.0.0.21
AARP_CS .. MIED1_S : Intercepts 10.0.0.21 -> 10.0.0.192

' ====== Offline attack-graph tooling ======
package "AttackGraph (MulVAL tooling)" {
  component "genScript.sh" as AG_S
  component "interaction_rules_def.P" as AG_R1
  component "interaction_rules_doppio.P" as AG_R2
  component "Docker image:\nwilbercui/mulval" as AG_D
  AG_S --> AG_D : docker run/exec\nvolume-mounts /input
  AG_S ..> AG_R1 : copies into container
  AG_S ..> AG_R2 : copies into container
  note bottom of AG_S
    Orchestrates MulVAL graph generation without metrics.
    Expects architecture input file.\nNo runtime coupling to PLCs/IEDs.
  end note
}

' ====== SCADA UI (present, no code-level coupling observed) ======
package "FUXA-SCADA-System" {
  component "fuxa_appdata/settings.js\nport 1881" as FUXA
  note bottom of FUXA
    Configuration present only.\nNo direct PLC/IED connections in codebase.
  end note
}

' ====== System setup script (host-level) ======
component "setup.sh\n(promisc on, xhost +)" as SYS
@enduml